/**
 * FIRESTORE SECURITY RULES FOR CHIEF G MEDIA
 * 
 * Apply these rules in Firebase Console:
 * 1. Go to Firebase Console > Firestore Database > Rules
 * 2. Replace the default rules with the content in firestore.rules file
 * 3. Click Publish
 * 
 * Rules Structure:
 * - Authenticated admins can create, read, update, delete announcements
 * - Authenticated admins can create, read, update, delete updates
 * - Public users can read announcements and updates (for frontend display)
 * - Unauthenticated users cannot modify data
 * - All uploads validated by type, size, and content structure
 * - Rich content fields validated: title, mainContent, tags, socialMediaLinks
 */

ANNOUNCEMENTS COLLECTION
========================
Collection Name: announcements
Purpose: Short promotional content with image and title

Fields Validated:
- title (string, 1-100 characters) - REQUIRED
- image (string, URL) - REQUIRED
- createdAt (timestamp) - REQUIRED
- updatedAt (timestamp) - REQUIRED
- createdBy (string, user ID) - REQUIRED
- updatedBy (string, user ID) - OPTIONAL

Permissions:
- READ: Public access (anyone can read for carousel)
- CREATE: Only authenticated users
- UPDATE: Only authenticated users
- DELETE: Only authenticated users

Validation Rules:
- Title must be 1-100 characters
- Image must be valid URL
- Timestamps must be present for create/update
- User ID tracking for audit trail


UPDATES COLLECTION
===================
Collection Name: updates
Purpose: Rich blog-style updates with multiple fields

Fields Validated:
- title (string, 1-150 characters) - REQUIRED
- mainContent (string, 1-2000 characters) - REQUIRED
- image (string, URL) - REQUIRED
- tags (array of strings) - OPTIONAL
  * Each tag is a string categorizing the update
  * Can be empty array
- socialMediaLinks (map/object) - OPTIONAL
  * Keys: facebook, twitter, instagram, linkedin, tiktok
  * Values: valid URLs (optional for each platform)
- createdAt (timestamp) - REQUIRED
- updatedAt (timestamp) - REQUIRED
- createdBy (string, user ID) - REQUIRED
- updatedBy (string, user ID) - REQUIRED for updates

Permissions:
- READ: Public access (anyone can read for updates page)
- CREATE: Only authenticated users
- UPDATE: Only authenticated users
- DELETE: Only authenticated users

Validation Rules:
- Title must be 1-150 characters
- Main content must be 1-2000 characters
- Image must be valid, non-empty URL
- Tags must be array type (can be empty)
- Social media links must be map type (can be empty)
- All timestamps required for track changes
- User IDs tracked for audit trail and accountability


ADMINS COLLECTION
==================
Collection Name: admins
Purpose: Track admin users and their access

Fields Tracked:
- uid (document ID) - user's Firebase UID
- email (string) - admin's email
- createdAt (timestamp) - when admin was added
- role (string) - admin role/permissions

Permissions:
- READ: Only the user can read their own admin document
- CREATE: Only authenticated users for their own UID
- UPDATE: Only the user can update their own document
- DELETE: Blocked (admin users managed by super-admin)


SECURITY FEATURES
=================

1. Authentication Validation
   - All write operations require authenticated user
   - Public read access for main content collections
   - No anonymous modifications allowed

2. Data Type Validation
   - All fields must match expected types
   - Arrays, maps, strings validated at database level
   - Invalid data rejected at write time

3. Data Structure Validation
   - Strings must be non-empty
   - Title length limits enforced (100 for announcements, 150 for updates)
   - Content length limits enforced (2000 max for updates)
   - URLs must be valid format

4. Audit Trail
   - createdBy and updatedBy track user responsible
   - createdAt and updatedAt track when changes occurred
   - Enables accountability and rollback if needed

5. Rate Limiting
   - Firestore enforces per-user write limits
   - Prevents spam and abuse
   - Configurable in Firebase Console

6. User Isolation
   - Admins can only manage their own admin profile
   - All users subject to same security rules
   - No special bypass mechanisms


ERROR MESSAGES RETURNED BY DATABASE
====================================

"Missing or insufficient permissions" (Error 7)
- User not authenticated
- Validation rule failed
- User doesn't have required permissions
- Action: Log in and ensure valid data format

"Invalid argument" (Error 3)
- Data type mismatch
- Invalid field name
- Action: Check data structure matches schema

"Permission denied" (Error 5)
- User trying to access unauthorized data
- Attempting to delete protected resource
- Action: Log in as authorized user


DEPLOYMENT CHECKLIST
====================
- [ ] Copy rules from firestore.rules file
- [ ] Go to Firebase Console > Firestore > Rules
- [ ] Paste rules into editor
- [ ] Review changes
- [ ] Click "Publish"
- [ ] Verify test reads/writes work
- [ ] Monitor error logs for 24 hours
- [ ] Document any issues

TESTING THE SECURITY RULES
===========================

Test Case 1: Anonymous User Read
- Open app without login
- Announcements carousel shows data ✓
- Updates page shows data ✓

Test Case 2: Unauthenticated Write
- Try to create announcement via console (should fail)
- Error: "Permission denied" ✓

Test Case 3: Authenticated User Create
- Login as admin
- Create announcement with valid data
- Success: Document created ✓

Test Case 4: Invalid Data
- Login as admin
- Try to create announcement with title > 100 chars
- Error: Validation fails ✓

Test Case 5: Update with All Fields
- Publish update with title, content, image, tags, social links
- All optional fields stored
- Success ✓

Test Case 6: Public Read Access
- Close browser, open new session
- View announcements and updates
- No authentication required ✓

Test Case 7: Delete Permission
- Login, delete update
- Update removed from database ✓
- Unauthenticated user cannot delete ✓


MIGRATION FROM OLD RULES
=========================

If upgrading from previous rules:
1. Backup current Firestore data
2. Review new validation requirements
3. Update any existing documents that don't meet new rules
4. Apply new rules
5. Test thoroughly
6. Monitor for errors during transition


FUTURE ENHANCEMENTS
====================

1. Custom Admin Claims
   - Set admin: true flag via Firebase Admin SDK
   - Restrict write access to true admins only
   - Add isAdmin() function check to rules

2. Per-Collection Admin Users
   - Different admins for announcements vs updates
   - Granular permission control
   - Role-based access control (RBAC)

3. Scheduled Publishing
   - Add publishedAt field for future publishing
   - Hide unpublished updates from public read
   - Timestamp validation

4. Content Moderation
   - Add status field (draft, published, archived)
   - Only published visible to public
   - Admin review workflow

5. Change Logs
   - Track all modifications with timestamps
   - Store previous values
   - Enable audit trail and rollback


SUPPORT & TROUBLESHOOTING
==========================

Common Issues:

1. "Permission denied" on CREATE
   - Ensure user is authenticated
   - Check all required fields present
   - Verify field types match schema
   - Check field lengths are within limits

2. Validations Not Working
   - Clear browser cache
   - Refresh Firestore rules in Console
   - Wait 1-2 minutes for rules deployment
   - Check console logs for exact error

3. Public Reads Not Working
   - Verify "allow read: if true;" in rules
   - Check document exists in database
   - Clear browser cache
   - Check browser developer tools for network errors

4. Admin Operations Blocked
   - Ensure user is logged in
   - Check Firebase Auth state
   - Verify user has valid session
   - Try re-authenticating


CONTACT & DOCUMENTATION
=======================

For questions about these rules, refer to:
- SECURITY_PERMISSIONS.md (detailed security guide)
- IMPLEMENTATION_CHECKLIST.md (deployment steps)
- Firebase Console > Firestore > Rules (live rules editor)
- Firebase Documentation: https://firebase.google.com/docs/firestore/security

